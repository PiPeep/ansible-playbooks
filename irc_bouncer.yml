---
# http://wiki.znc.in/Running_ZNC_as_a_system_daemon
- hosts: buyvm
  sudo: yes

  vars_prompt:
    - name: znc_password
      prompt: Password for znc bouncer
      private: yes

  tasks:

    - name: install znc
      apt: pkg=znc state=present

    - name: create znc user
      user: >
        user=znc
        comment="ZNC IRC Bouncer Service"
        system=yes
        home=/var/lib/znc
        createhome=yes

    - name: install znc init.d script
      copy: >
        src=resources/etc/init.d/znc
        dest=/etc/init.d/znc
        mode=755
        owner=root
        group=root
      notify:
        - register znc init.d script
        - restart znc service

    - name: generate password hash
      shell: >
        SALT="$(head /dev/urandom | uuencode -m - | sed -n 2p | cut -c-16)";
        echo -n "sha256#$(
        echo -n '{{znc_password}}'$SALT | sha256sum | cut -b -64
        )#$SALT#"
      register: znc_hash

    - name: generate znc directory structure
      file: >
        dest=/var/lib/znc/{{item}}
        mode=700
        owner=znc
        group=znc
        state=directory
      with_items:
        - configs
        - modules

    - name: configure znc
      template: >
        src=resources/etc/znc/znc.conf
        dest=/var/lib/znc/configs/znc.conf
        mode=600
        owner=znc
        group=znc
      notify:
        - restart znc service

    - name: link znc configuration to /etc
      file: >
        src=/var/lib/znc/configs
        dest=/etc/znc
        state=link

    - name: generate znc pem file (for ssl)
      command: >
        sudo -u znc znc --datadir=/var/lib/znc --makepem
        creates=/var/lib/znc/znc.pem
      notify:
        - keep znc private key from being world-readable
        - restart znc service

  handlers:

    - name: register znc init.d script
      command: update-rc.d znc defaults

    - name: restart znc service
      service: name=znc state=restarted

    - name: keep znc private key from being world-readable
      file: >
        dest=/var/lib/znc/znc.pem
        mode=600 # By default this is 644, which is too liberal
        owner=znc
        group=znc
